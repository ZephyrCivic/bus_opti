/**
 * src/features/duties/hooks/useDutyCsvHandlers.ts
 * Duties CSV のインポート／エクスポート処理をまとめる。
 * Duty 選択状態の更新もここで行い、ビューを簡潔に保つ。
 */
import { useCallback } from 'react';
import { toast } from 'sonner';

import { buildDutiesCsv } from '@/services/export/dutiesCsv';
import { parseDutiesCsv } from '@/services/import/dutiesCsv';
import type { DutyEditorActions } from '@/services/import/GtfsImportProvider';
import type { DutyEditState } from '@/types';
import type { BlockTripLookup } from '@/services/duty/dutyMetrics';
import { downloadCsv } from '@/utils/downloadCsv';
import { recordAuditEvent } from '@/services/audit/auditLog';
import { aggregateDutyWarnings } from '@/services/duty/aggregateDutyWarnings';
import { useExportConfirmation } from '@/components/export/ExportConfirmationProvider';
import type { SegmentSelection } from './useDutySelectionState';

interface DutyCsvParams {
  dutyActions: DutyEditorActions;
  dutyState: DutyEditState;
  tripIndex: Parameters<typeof parseDutiesCsv>[1];
  tripLookup: BlockTripLookup;
  setSelectedDutyId: (id: string | null) => void;
  setSelectedSegment: (selection: SegmentSelection | null) => void;
  setSelectedBlockId: (id: string | null) => void;
  setStartTripId: (id: string | null) => void;
  setEndTripId: (id: string | null) => void;
}

interface DutyCsvResult {
  handleImportFile: (file: File) => Promise<void>;
  handleExport: () => void;
  handleImportClick: (input: HTMLInputElement | null) => void;
}

async function readFileAsText(file: File): Promise<string> {
  return await new Promise<string>((resolve, reject) => {
    const reader = new FileReader();
    reader.onerror = () => reject(new Error('ファイルの読み込みに失敗しました。'));
    reader.onload = () => resolve(String(reader.result ?? ''));
    reader.readAsText(file);
  });
}

export function useDutyCsvHandlers(params: DutyCsvParams): DutyCsvResult {
  const {
    dutyActions,
    dutyState,
    tripIndex,
    tripLookup,
    setSelectedDutyId,
    setSelectedSegment,
    setSelectedBlockId,
    setStartTripId,
    setEndTripId,
  } = params;
  const { requestConfirmation } = useExportConfirmation();

  const buildSnapshot = useCallback(() => {
    const exportData = buildDutiesCsv(dutyState.duties, {
      dutySettings: dutyState.settings,
      tripLookup,
    });
    const warningTotals = aggregateDutyWarnings(dutyState.duties, tripLookup, dutyState.settings);
    return { exportData, warningTotals };
  }, [dutyState.duties, dutyState.settings, tripLookup]);

  const handleImportFile = useCallback(
    async (file: File) => {
      try {
        const csv = await readFileAsText(file);
        const parsed = parseDutiesCsv(csv, tripIndex);
        dutyActions.replace(parsed.duties);
        if (parsed.duties.length === 0) {
          setSelectedDutyId(null);
          setSelectedSegment(null);
          setStartTripId(null);
          setEndTripId(null);
          toast.success('Duties CSV を読み込みました（0件）。');
          return;
        }
        const firstDuty = parsed.duties[0]!;
        setSelectedDutyId(firstDuty.id);
        const firstSegment = firstDuty.segments[0];
        if (firstSegment) {
          setSelectedSegment({ dutyId: firstDuty.id, segmentId: firstSegment.id });
          setSelectedBlockId(firstSegment.blockId);
          setStartTripId(firstSegment.startTripId);
          setEndTripId(firstSegment.endTripId);
        } else {
          setSelectedSegment(null);
          setStartTripId(null);
          setEndTripId(null);
        }
        const metadataNote = parsed.generatedAt ? `（${parsed.generatedAt}）` : '';
        toast.success(`Duties CSV を読み込みました（${parsed.duties.length} Duty）${metadataNote}`);
      } catch (error) {
        toast.error(error instanceof Error ? error.message : 'Duties CSV の読み込みに失敗しました。');
      }
    },
    [dutyActions, setEndTripId, setSelectedBlockId, setSelectedDutyId, setSelectedSegment, setStartTripId, tripIndex],
  );

  const handleExport = useCallback(() => {
    if (dutyState.duties.length === 0) {
      toast.info('エクスポート可能な Duty がありません。');
      return;
    }
    const { exportData, warningTotals } = buildSnapshot();
    requestConfirmation({
      title: 'Duties CSV を出力しますか？',
      description: '警告件数と未割当の状況を確認した上で出力を続行できます。',
      summary: {
        hardWarnings: warningTotals.hard,
        softWarnings: warningTotals.soft,
        unassigned: warningTotals.unassigned,
        metrics: [
          { label: '行数', value: `${exportData.rowCount}` },
          { label: '設定ハッシュ', value: exportData.settingsHash },
        ],
      },
      context: { entity: 'duties', exportType: 'duties-csv', fileName: exportData.fileName },
      onConfirm: () => {
        const { exportData: latestExport, warningTotals: latestWarnings } = buildSnapshot();
        downloadCsv({ fileName: latestExport.fileName, content: latestExport.csv });
        recordAuditEvent({
          entity: 'duties',
          fileName: latestExport.fileName,
          rowCount: latestExport.rowCount,
          generatedAt: latestExport.generatedAt,
          settingsHash: latestExport.settingsHash,
          warnings: { hard: latestWarnings.hard, soft: latestWarnings.soft },
        });
        toast.success(`Duties CSV をダウンロードしました（${latestExport.rowCount} 行）`);
      },
    });
  }, [buildSnapshot, requestConfirmation]);

  const handleImportClick = useCallback((input: HTMLInputElement | null) => {
    input?.click();
  }, []);

  return { handleImportFile, handleExport, handleImportClick };
}

