<!--
  docs/specs/block-ui-redesign.md
  場所: docs/specs/
  目的: 「ブロック」画面のUIリデザイン要件を整理し、日別表示と重なりハイライトを含む拡張方針を明確化する。
  背景: TODO「ブロック画面の UI リデザイン（サービス線の可視化）」のDoDを満たす準備として。
-->

# ブロック画面 UI リデザイン設計メモ（2025-10-08）

## 背景
- 現行 BlocksView は統計カード + テーブル + タイムラインのみで、サービス線（日別ビュー）や重なりハイライトが不足。
- Duty 編集や Diff 機能との整合のため、Block の日別構造と重複状況を視覚的に把握できる UI が求められている。
- KPI × UX パネルや Timeline インタラクション拡張と連携し、編集フロー全体の可視性を高める必要がある。

## ゴール
1. サービス日ごとの Block 表示と切替を提供し、日跨ぎケースを適切に表示する。
2. Block 内での重複・ギャップを色分け/ハイライトで提示し、Duty への影響を即座に把握できる。
3. 重なり状況やターンギャップを基に、改善アクション（調整/再計算/Export）へ繋げる操作を提供する。

## ユースケース
- 運用チームが特定日（例: 月曜）の増便/欠便に伴う Block 重複をチェックし、Duty の再割当を判断。
- CS チームが顧客からの報告（ピーク時間の重複）に対し、該当 Block を検索しタイムラインで重なりを共有。
- プランナーがターン間隔を変更した後、ギャップが閾値内に収まっているかをハイライトで確認。

## UI構成案
1. **ヘッダー**
   - 日付/サービスカレンダーフィルタ（`service_id`、曜日タブ）。
   - ターン間隔入力の横に「ハイライト条件」ドロップダウン（重複/ギャップ/relief 未設定など）。
2. **サービス日別タイムライン**
   - 選択日とその前後日のタブを表示（3日分をスワイプ/スクロール可能）。
   - タイムラインは日別にスクロール領域を分け、24:00→28:00 等の延長表示に対応。
   - 重なり: 同時間帯に複数 Block が存在する場合、オーバーレイで赤系グラデーションを表示。
3. **Block 詳細カード**
   - 選択した Block の Summary（Trip 数、始終着時間、ターンギャップ最大/min、relief 点数）。
   - 競合 Block リスト（同時間帯/同ドライバー候補）を表示し、Duty 編集画面へジャンプするボタンを設置。
4. **サービス線図（ミニマップ）**
   - MapLibre の軽量プレビュー（既存マップデータから線形描画）を表示し、車庫/relief ポイントとの関連を表示（P2）。
   - 初期リリースでは静的画像/スケルトンを表示し、クリックで Explorer タブへ遷移。
5. **アクションバー**
   - Blocks CSV/JSON エクスポート（既存 + JSON 拡張）。
   - Diff ベースラインと比較するショートカット。
   - ハイライトレポートを CSV にダウンロード（重複/ギャップ一覧）。

## データ要件
- サービス日/曜日のメタ情報：`plan.csvRows` と GTFS `calendar` を参照し、`service_id`→日付マッピングを事前計算。
- 重複検出：Block 内 Trip の `startMinutes`/`endMinutes` を比較し、閾値内の重なり/ギャップを算出。
- Relief/Depot 情報：`manual` データと `docs/demo` を参照し、Block がどの施設を通過するかのマッピングを準備。
- 追加出力フォーマット：重複レポート（Block ID、競合Block、時間帯、重なり率）。

## 実装ステップ案
1. **設計・データ整備**
   - サービス日フィルタと重複判定ロジックを `useBlocksPlan`（新設）で提供。
   - 重複/ギャップ計算をユニットテスト化（`tests/blocks.overlap.test.ts`）。
2. **UI リニューアル**
   - Timeline セクションを日別タブ + ハイライト付きに再構築。
   - Block 詳細カード/競合リスト/アクションバーを追加するコンポーネント分割。
3. **サービス線プレビュー**
   - MapLibre プレビュー or スケルトンを表示。初期は静的画像/リンクで代替し、P2 でインタラクティブ化。
4. **エクスポート強化**
   - JSON 出力と重複レポートCSVを `buildBlocksExport`（新設）で生成。
5. **テスト・ドキュメント**
   - UI レンダリングテスト（`tests/blocks.ui.redesign.test.tsx`予定）でタブ/ハイライト表示を検証。
   - README/DOCS 更新、Chrome DevTools CLI でスクリーンショット取得。

## リスクと対策
- **データ量増加**: 大規模なGTFSでタブに大量Blockが載る → 仮想スクロールと検索を導入。
- **ハイライトの誤検出**: 連続Tripの境界で誤差が出る可能性 → 1分未満の重なり/ギャップは無視する閾値設定。
- **マップ表示の負荷**: MapLibre プレビューが重い場合、静的サムネイルにフォールバック。
- **UIの複雑化**: タブ + 詳細 + マップで情報過多にならないよう、段階的開閉とガイドツールチップを用意。

## ロードマップ（目安）
1. Week1: 重複計算ユーティリティとサービス日フィルタ実装（1.5日）  
2. Week2: タイムラインタブ・ハイライト表示を実装（2日）  
3. Week3: Block詳細カード・アクションバー・エクスポート強化（2日）  
4. Week4: サービス線プレビュー（静的）＋テスト/ドキュメント更新（2.5日）

## 関連ドキュメント
- `docs/specs/timeline-interactions.md`
- `docs/specs/diff-export-rollout.md`
- `docs/specs/file-write-audit.md`
- `docs/specs/distribution-approval.md`
- `docs/TODO.md`
