# 保存系アクション導線見直し（仕様・導線整理）

最終更新: 2025-10-22

## 目的
- 保存・出力アクションを左ナビ「差分・出力」へ集約し、ImportView 直後の迷いを解消する。
- 保存系の文言・トリガー・ガードを統一し、ユーザーが現在の状態（未保存/ドラフト/エクスポート）を把握しやすくする。
- 権限・監査ポリシー（persistence-and-recovery、diff-export 系仕様）との齟齬をなくし、実装計画に反映できる粒度の要件をまとめる。

## 背景
- 2025-10-22 の PO レビューで「Import 完了直後に保存ボタンが複数箇所に出現し、どれを使えば良いか迷う」との指摘。
- 現行 UI は ImportView に簡易保存パネル、左ナビに差分/出力パネル、Explorer/Duties 上部に保存バナーが混在。
- Diff / Export スコープ更新（docs/specs/diff-export-scope.md）で JSON 出力や履歴管理を追加予定のため、導線を先に再設計しておく必要がある。

## スコープ
- 対象画面: ImportView、Explorer、Blocks、Duties、左ナビ（差分・出力タブ）、グローバル通知。
- 対象アクション: 手動保存（プロジェクトJSON）、取込結果保存（取込結果JSON）、CSV/JSON エクスポート、監査ログダウンロード。
- 非スコープ: 自動保存間隔、API レイヤー、ファイルフォーマット仕様（既存仕様に準拠）。

## ユーザージャーニー（保存系）
1. Import 完了 → 取込サマリーで状況把握。
2. 左ナビ「差分・出力」を開き、保存 or エクスポート方式を選択。
3. 保存実行後はトーストで完了を通知しつつ、履歴リストへ即時反映。
4. 差分確認後に必要な CSV/JSON をエクスポートし、監査ログが自動追加される。
5. 追加編集後はバナーではなく差分タブのバッジで未保存を示す。

## ナビゲーション構成（案）
- 左ナビ: 「差分・出力」内に 3 セクションを配置
  - **保存**（Primary CTA）: `プロジェクトを保存（JSON）`、`取込結果を保存（JSON）`
  - **エクスポート**: `Blocks CSV`、`Duties CSV`、`Diff JSON`
  - **履歴 & 監査**: 最新 5 件の保存/出力履歴、`監査ログをダウンロード`
- Explorer / Blocks / Duties 画面の上部バナーは廃止し、代わりに左ナビタブに未保存バッジ（赤点）を表示。
- ImportView の保存カードは削除し、サマリー下ヒントを左ナビ誘導に一本化。

## 状態表示とフィードバック
- 未保存ドラフトがある場合、左ナビタブに `● 未保存あり` バッジ、ツールチップで「前回保存: YYYY-MM-DD HH:mm」。
- 保存成功時はトースト表示（自動閉じ 4s）＋履歴リスト最上段へ挿入。
- 保存失敗時は `role="alert"` のエラーカードを差分パネル冒頭に表示し、再試行ショートカットを提供。
- エクスポート実行時はダウンロード開始と同時に監査イベント作成、完了後トーストでファイル名を案内。

## 権限・ロールとの整合
- `config.py` の `roles.downloadExport` が `false` のユーザー: エクスポートセクションを `aria-disabled="true"`＋鍵アイコンで表示、トリガー不可。
- 保存（JSON）は全ロール利用可。ただし監査ログダウンロードは管理者のみ。
- 履歴リストは権限に応じて非表示項目をマスク（例: ダウンロード不可ロールにはファイルリンクを表示しない）。

## アクセシビリティ要件
- 左ナビ内セクションヘッダーは `<h3>` 相当でランドマークを形成。
- 全ボタンに明示テキスト、`aria-describedby` でファイル種別・保存内容を説明。
- 履歴リストは `<ul>` 構造＋キーボード操作でフォーカス遷移、Enter でダウンロード/詳細。
- エラーカードは `role="alert"` と `tabindex="-1"` を付与し、表示時にフォーカスを移動。
- トーストは `aria-live="polite"` で内容更新を読み上げる。

## KPI / テレメトリ
- 保存完了率 ≥ 99%（月次集計）。
- 保存導線の滞在時間（Import 完了→初回保存）中央値 < 90 秒。
- 左ナビ差分タブのクリック率（Import 後 5 分以内）を計測し、改善前比 +30% を目標。

## 受入基準（仕様段階）
- 左ナビ集約後のセクション構成・文言・ボタンラベルが確定している。
- 未保存状態の通知手段（バッジ/トースト/履歴更新）がモックで説明されている。
- 権限別の UI 表示差分とアクセシビリティ要件が明文化されている。
- KPI とテレメトリ項目が定義され、後続の Exec Plan で計測実装を計画できる。

## 影響範囲
- コンポーネント: `SidebarNav`, `DiffExportPanel`, `ImportView`, 各画面トップバー。
- 状態管理: 保存ステータスストア、ダウンロード履歴ストア、トースト通知。
- ドキュメント: README 保存項、docs/specs/diff-export-scope.md との整合、サポートFAQ更新。

## 非機能・パフォーマンス
- 左ナビ開閉操作は 100ms 以内に反応。
- 履歴リストは最新 20 件まで表示し、古い項目はページングまたは「すべて表示」モーダルへ。
- 保存実行後 200ms 以内に未保存バッジを消灯する（ストア更新）。

## 次アクション
- モック（docs/specs/save-flows-navigation.mock.md）で表示例を共有し、PO/UX レビューを取得。
- Exec Plan: 保存導線見直し（実装）を `plans.md` へ追加し、実装タスクを分割。
- README / FAQ の更新項目をバックログへ登録。
