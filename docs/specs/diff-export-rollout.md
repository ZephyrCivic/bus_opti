<!--
  docs/specs/diff-export-rollout.md
  場所: docs/specs/
  目的: Diff / Export 機能の段階的ロールアウトとサポート体制を整理する。
  背景: TODO「Diff / Export のロールアウト計画」の DoD を満たし、関係者間で共通認識を持つ。
-->

# Diff / Export ロールアウト計画（2025-10-08）

## 背景
- P0 で Diff 最小 UI と Blocks / Duties CSV エクスポートを提供済み。
- P1 拡張としてスコープ拡大（JSON 出力、履歴 UI、権限管理）を決定済み（参照: `docs/specs/diff-export-scope.md`）。
- 段階的公開により、運用チームと顧客サポートがリスクを抑えながら機能定着を図る必要がある。

## 前提・準備
- **設定値**: ダウンロード権限は `config.py` の `roles.downloadExport` トグルで制御し、初期値は `false`（グローバル公開前に検証期間を確保）。
- **モニタリング**: `docs/diff-baselines/` に保持する履歴スナップショットを週次で確認し、Diff KPI（alert 件数、未割当率）を追跡。
- **サポート窓口**: 社内問い合わせは OPS Slack `#duty-diff-support`、顧客向けはサポートフォーム経由（CS チームが一次受け）。

## ロールアウトフェーズ
### フェーズ0: 開発チーム内 QA（2025-10-08〜2025-10-10）
- 対象: プロダクトチーム（Codex + QA）。
- 目的: JSON 出力と履歴 UI の主要シナリオを `npm test` + `npm run smoke:chrome` で検証。
- サポート: バグは Jira `DIFF-ROLLOUT` Epic に記録。重大度 S1 は即日修正、S2 以上はフェーズ1開始前に解消。

### フェーズ1: 社内パイロット（2025-10-13〜2025-10-24）
- 対象: 運用部隊（Scheduling Ops）3 チーム。
- 公開範囲: CSV / JSON エクスポート、履歴 UI。有効化は `config.py` のロール設定で対象アカウントを allowlist。
- 目的: 実務データで差分比較フローを通し、権限ガード・履歴保持の課題を洗い出す。
- KPI: エクスポート失敗率 < 5%、サポート対応 SLA（初動 4h 以内）を満たす。

### フェーズ2: 顧客限定公開（2025-10-27〜2025-11-07）
- 対象: 既存顧客 2 社（A/B テナント）。
- 公開範囲: パイロットと同等。ただし Download ガードは管理者のみに付与し、利用状況をログ収集。
- 目的: 実運用データでのパフォーマンス・監査証跡の妥当性確認。サポート FAQ 草稿を更新。
- KPI: サポートチケット分類「Diff / Export」が月次全体の 20% を超えない、重大障害ゼロ。

### フェーズ3: 一般提供（2025-11-11 予定）
- 条件: フェーズ2で重大障害ゼロ、監査チェックリスト（下記）を満たす、FAQ / README 更新完了。
- 対象: 全テナント。Download ガードは `config.py` でロール別に公開（管理者=ON、一般ユーザー=OFF が初期値）。
- フォローアップ: 2025-12-01 に振り返りレビューを実施し、改修 backlog を整理。

## リスクと対策
- **権限設定漏れ**: チェックリストに「config.py のロール定義レビュー」を追加し、毎フェーズ開始前に ops が承認。
- **履歴データ肥大化**: `docs/diff-baselines/` は最大 30 スナップショットを保持し、古いものからアーカイブ（S3 手動アップロード）。
- **CSV/JSON スキーマ変更**: 仕様変更時は `docs/specs/diff-export-scope.md` を更新し、互換性ガイドを README に追記。
- **サポート負荷増大**: 週次でサポートチケットを分析し、FAQ へ反映。必要に応じてライブトレーニングを追加。

## サポート & コミュニケーション
- リリースノートはフェーズごとに `docs/releases/`（新設予定）へ記録し、社内は Ops Sync / 外部はメールで告知。
- トレーニング: フェーズ1開始前に 30 分のハンズオンを実施し、録画をナレッジベースへ保存。
- 問い合わせ一次対応: CS チームが 4 時間以内に返答、技術調査が必要な場合は Duty プロダクトチームへエスカレーション。

## KPI と監査チェックリスト
- KPI: 
  - Export 成功率 ≥ 95%
  - ダウンロード権限違反（未許可ユーザーのアクセス試行）= 0 件
  - Diff アラート未処理件数（赤）≦ 3（週次レビュー時点）
- チェックリスト（各フェーズ開始前に確認）
  1. `config.py` のロール設定とデフォルト値をレビュー済み。
  2. `docs/diff-baselines/` のスナップショット整理完了。
  3. README / FAQ の更新内容を QA が確認。
  4. サポートチケット分類に「Diff / Export」が追加済み。

## 関連ドキュメント
- `docs/specs/diff-export-scope.md`
- `docs/DECISIONS_2025-10-06.md`
- `docs/TODO.md`
