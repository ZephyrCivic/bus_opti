<!--
  docs/specs/ui-mock.md
  目的: 実装前にUIの骨格・操作フロー・警告表示の在り方を共有する。
  方針: Small, clear, safe steps。最適化なし、警告は保存を妨げない。
  日付: 2025-10-17
-->

# UI モック（ASCII）— 行路＋交番表

本書は、GTFS→行路（Blocks）→交番（Duties）を「視覚的に組み立てる」ためのUI草案です。実装に先立ち、画面構成・操作・警告表示の期待値を固定します。

参照: docs/specs/requirements-blocks-duties.md（要件・CSV・警告レベル） / readme.md（ゴール）

## 共通
- タブ: Import | Explorer | Blocks | Duties
- 右上: CSV Import/Export（画面に応じて）
- 通知: トースト（成功/失敗）、サイドパネル（詳細）
- 警告バッジ: critical=赤, warn=黄, info=灰

---

## Split Mode（同期スプリット表示）

Blocks と Duties を上下に同時表示し、選択・時間カーソル・ズームを同期します。片方での編集結果が即座にもう一方へ反映され、手動割付の作業性を高めます。

```
+-------------------------------------------------------------------------------+
| Tabs: Import | Explorer | Blocks | Duties | Vehicles | Manual                 |
+-------------------------------------------------------------------------------+
| Split:  Blocks (上) ┃ Duties (下)                                              |
|        [Day 1]                                                                  |
|--------------------------------------------------------------------------------|
| Blocks (上)                                                                      |
|  BLOCK_001: [A:TRIP_A1 08:10-08:55] ── deadhead 5m ──> [B:TRIP_B4 09:10-09:45] |
|             ── gap 20m ──> [A:TRIP_A7 10:05-10:40]                               |
|--------------------------------------------------------------------------------|
| Duties (下)                                                                      |
|  D001 (DRV-01): [Seg1] [食事 45m] [Seg2]                                         |
|  D002 (DRV-02): [Seg1]                                                           |
+-------------------------------------------------------------------------------+
Legend: 太いカラー=営業便, 斜線=待機/layover, 緑/薄色帯=食事/休憩, 細い黒=回送, ●=警告/交代点
Sync:
- 選択同期: 上で選んだ Block/Duty を下でもハイライト。
- 時間カーソル同期: 垂直カーソルを共有（現在時刻/ホバー位置）。
- スクロール/ズーム同期: 時間軸の拡大縮小を連動。
Shortcuts: Tab=フォーカス切替, S/E/Enter=Connect, A=新規Duty, Z/Y=Undo/Redo。
```

- トークンパネル: Dutyビューのアクション列に「休憩」「回送」トークンを常時表示し、ギャップへドラッグするとギャップ長をプレビューして自動挿入できる。
- 未割当一覧: 各行にドラッグハンドルを設け、Duty タイムラインへ直接ドロップして新しい Duty を生成する。

---

## Route Explorer（全ルート個別表示）

```
+--------------------------------------------------------------------------------+
| Tabs: Import | Explorer | Blocks | Duties                                      |
+--------------------------------------------------------------------------------+
| Filters: [Service Day ▼] [Route search: __________ ] [Direction: 0/1]         |
|--------------------------------------------------------------------------------|
| Map (左)                                   | Route Timeline (右)                  |
|  ◯ 停留所/Depot/Relief オーバレイ           |  TRIP_1001  [08:10──08:55]           |
|  線：shapes or 近似                         |  TRIP_1003  [09:10──09:45]           |
|                                             |  …                                   |
+--------------------------------------------------------------------------------+
| Footer: Selected route=R-01  trips=267  stops=369  alerts=0                    |
+--------------------------------------------------------------------------------+
```

操作:
- ルート選択→右側タイムラインで便の時系列を確認。
- Mapオーバレイの ON/OFF（Depots/Relief）。

---

## Block Builder（行路の手作り）

```
+-------------------------------------------------------------------------------+
| Tabs: Import | Explorer | Blocks | Duties                                     |
+-------------------------------------------------------------------------------+
| Day: [Day 1 ▼]                                                                 |
|--------------------------------------------------------------------------------|
| Trips Timeline                                                                |
|  TRIP_1001 [08:10-08:55]    TRIP_1003 [09:10-09:45]     TRIP_1010 [10:05-…]   |
|  [Start] クリック → [End] クリック → CONNECT                                    |
|--------------------------------------------------------------------------------|
| Candidates (effective gap昇順)              | Warnings（選択中の連結）             |
|  BLOCK_001  eff_gap=25m (-5m deadhead)      |  BLK_TURN_SHORT   warn               |
|  BLOCK_008  eff_gap=30m (ruleなし近似)       |  BLK_AFTER_HOURS  warn               |
|                                             |  BLK_DEADHEAD_EXCEEDS  critical     |
+--------------------------------------------------------------------------------+
| Coverage: 84%   Unassigned trips: 42     [Export Blocks CSV]                  |
+--------------------------------------------------------------------------------+
```

操作:
- 便の端点（start/end）を選んで連結。候補は実効gap（gap−deadhead）昇順に提示。
- 右ペインで警告を即時表示（保存は可能）。
- 画面上部はサービス日と操作ガイドのみ表示（連結しきい値は Step2 で復帰予定）。

食事/休憩（アクティビティ帯）
- Duty編集と同じ見た目で、Blocks 上でも挿入位置の候補をガイド表示（保存はDuties側）。
- 交代所/停留所にスナップし、`minBreak`未満は warn を表示。

---

## Duty Builder（交番の組立）

```
+-------------------------------------------------------------------------------+
| Tabs: Import | Explorer | Blocks | Duties                                     |
+-------------------------------------------------------------------------------+
| Drivers（左）                | Duty Timeline（中央）           | Inspector（右）     |
| [DRV-01]                     | D001: [Seg1][Seg2]              | Duty ID: D001       |
| [DRV-02]                     | D002: [Seg1]                    | Driver: DRV-01      |
| [DRV-03] …                  | （ブロック単位のドロップ先）      | Warnings: …         |
|  ドラッグで割付               | セグメントの並べ替え/削除          | CSV: Import/Export  |
+-------------------------------------------------------------------------------+
```

操作:
- 従業員リストから Duty にドラッグ&ドロップで割付け。
- Duty 内セグメントの追加/移動/削除（現行機能継承）。
- 警告（連続運転/休憩/交代所/車庫）をDuty単位で表示。保存は可能。

休憩・食事の表現
- 活動タイプ: `meal` / `break` / `layover`（最小は meal と layover）。
- 表示: 「食事 45m」など帯に明示。下限未満は warn。ReliefPointの時間帯外も warn。
- 操作: Duty上の隙間をクリック→候補（食事/layover）を選択→分数を入力。Undo/Redo 対応。

---

## Manual（Vehicles / Vehicle Types）

```
+-------------------------------------------------------------------------------+
| Tabs: Import | Explorer | Blocks | Duties | Manual                              |
+-------------------------------------------------------------------------------+
| Vehicle Types                                                                 |
|  [Import CSV] [Export CSV]                                                     |
|  type_id   name       wheel(low)  seated  total  tags                          |
|  VT-STD    標準車     1(1)        30      70     city,non-step                 |
|  VT-LF     低床大型   1(1)        36      80     brt,low-floor                 |
|--------------------------------------------------------------------------------|
| Vehicles                                                                       |
|  [Import CSV] [Export CSV] [Add]                                               |
|  vehicle_id  vehicle_type  depot_id  seats  whl  low  notes                    |
|  BUS-001     VT-STD       DEPOT-A   30     1    1    2022年導入                |
|  BUS-002     VT-LF        DEPOT-B   36     1    1                                |
+-------------------------------------------------------------------------------+
```

操作:
- CSV Import/Export で台帳の入出力。未知列は無視して前方互換。
- 1行追加/削除、簡易編集（数値/ON/OFF）。
- depot_id は既存 Depots からの参照（未登録なら警告）。

---

## Vehicles View（配車・任意）

```
+-------------------------------------------------------------------------------+
| Tabs: Import | Explorer | Blocks | Duties | Vehicles | Manual                 |
+-------------------------------------------------------------------------------+
| Unassigned Blocks (左)                | Vehicles Gantt（右：縦=vehicle_id）       |
|  BLOCK_001 [08:10-10:40]              | BUS-001: [BLOCK_003]───[BLOCK_009]        |
|  BLOCK_008 [07:50-09:30]              | BUS-002: [BLOCK_001]  ╳[BLOCK_008]        |
|  …                                    |           ↑ 重複（VEH_OVERLAP critical）   |
+-------------------------------------------------------------------------------+
| Footer: Export vehicle-assignments.csv   |  警告: overlap=1 after-hours=0 radius=2  |
+-------------------------------------------------------------------------------+
```

操作:
- 左リストの Block を車両レーンへドラッグ&ドロップで割付／解除。
- 重複・距離・営業時間外はバッジ表示（保存は可能）。
- CSV入出力: `vehicle-assignments.csv` を採用（未知列は無視）。

---

## 警告UIの挙動（共通）
- 一覧（Blocks/Duties）にバッジと件数を表示。フィルタ: criticalのみ / warn以上 / すべて。
- セグメント編集・連結直後に即時計算して右ペインに詳細を表示。
- 技術エラー（blocking）は保存/適用を止め、メッセージを明示。

凡例（色とパターン）
- 太いカラー帯: 営業運行（trip 区間）。ルート別に色分け、越境時は [A→B] チップ表示。
- 細い黒/濃灰帯: Deadhead/出入庫。所要分を帯長で表現、注記に `deadhead 5m` など。
- 斜線ハッチ: 待機/layover（休息）。
- 緑や薄色の帯: 食事/休憩。ラベルに「食事」表記と分数。
- 小さな丸/菱形: 警告（橙/赤）や交代ポイント。

---

## CSV アクション
- Blocks: 現行の `blocks.csv` に将来列追加可能（読み込みは既存列のみ）。
- Duties: `duties.csv`（確定仕様）を入出力。将来 `violations/warnings` 列を追加しても後方互換。

---

## ショートカット（任意・将来）
- Blocks: `S`=Start選択, `E`=End選択, `Enter`=CONNECT, `Del`=解除
- Duties: `A`=新規Duty, `U`=割付解除, `Z`/`Y`=Undo/Redo

---

## DoD（UI観点）
- Explorerでルート個別表示（地図/タイムライン）が成立。
- Blocksで連結操作→警告即時表示→CSV出力まで通る。
- Dutiesで従業員割付→警告表示→CSV出力まで通る。

