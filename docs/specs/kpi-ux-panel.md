<!--
  docs/specs/kpi-ux-panel.md
  場所: docs/specs/
  目的: KPI × UX パネル拡張のUI/機能要件と実装ステップを整理する。
  背景: Dashboard最小UIから、グラフ・詳細ビューを含む拡張DoDに進むため。
-->

# KPI × UX パネル拡張 仕様メモ（2025-10-08）

## 背景
- P0では KPI カード（5項目）と警告リスト、閾値編集モーダルを提供済み。
- 追加要件では、視覚化（グラフ）と詳細テーブル、操作ログ連動を含む総合的なパネルを求められている。
- Diff / Export ロールアウトや承認フローと連携し、意思決定に必要な指標を迅速に確認できるUIを目指す。

## ゴール
1. **視覚化の追加**: Duty KPI を日別またはドライバー別に可視化するグラフを提供。
2. **詳細ビュー**: KPIの原データをフィルタリング可能なテーブルで提供し、アクション（エクスポート、連絡）に繋げる。
3. **操作ログ連動**: 承認フローや監査ログと紐づけ、アラートの対応状況を追跡。

## ユースケース
- 運用マネージャーが週次レビューで未割当 Duty の推移を確認し、対応状況をチームに共有。
- CS チームが顧客からの問い合わせ時に、特定ドライバーの拘束時間推移を即座に提示。
- 監査担当が、アラート放置件数が閾値を超えた時点でSlack通知するためのトリガー情報を収集。

## UI構成案
1. **KPI カードエリア（既存強化）**
   - クリックで詳細パネルへジャンプ。
   - トレンドアイコン（上昇/下降）を表示し、前週比を色分け（緑/赤）。
2. **グラフセクション**
   - `D3.js` ではなく `@tanstack/charts` or `recharts` の導入を検討（既存依存とバンドルサイズで比較）。
   - グラフ種類:
     - 未割当 Duty 数の推移ラインチャート。
     - ドライバー別総勤務時間の棒グラフ（Top5 + その他）。
     - 夜勤比率ヒートマップ（オプション、P2）。
   - 操作: 日付レンジフィルタ、ドライバータグフィルタ。
3. **詳細テーブルセクション**
   - `@tanstack/react-table` 既存利用を拡張。
   - カラム例: Duty ID, ドライバー, 稼働時間, 休憩不足, 夜勤回数, 最終更新日時, 対応ステータス。
   - 行アクション: `対応済みにする`、`Slack通知`（WebHook連携はバックログ）。
4. **アラートタイムライン**
   - `docs/diff-baselines/` の履歴と連動し、アラート発生→対応→クローズまでをタイムラインで表示。
   - フィルタ: severity（critical/warning）、ステータス（open/acknowledged/resolved）。

## データソースと整合
- 既存 `computeDutyDashboard` の出力に加え、以下の拡張を検討:
  - 日別メトリクス配列（`dailyMetrics[]`）。
  - ドライバー別集計 (`driverWorkloads[]`)。
  - アラート履歴 (`alertHistory[]`)：Diffベースラインや監査ログから生成。
- `config.py` の閾値と整合させ、UIで表示する数値は設定値に基づく。
- `docs/specs/file-write-audit.md` による監査ログ形式を参照し、未対応アラートを抽出。

## 実装ステップ案
1. **設計・データ整備**
   - `computeDutyDashboard` を拡張し、日次/ドライバー別集計を返す。
   - 新型データを `DashboardView` に渡す hooks を作成（`useDutyDashboardMetrics`）。
2. **グラフライブラリ選定**
   - パフォーマンスとバンドルサイズを比較し、1ライブラリに統一。
   - 選定結果を README/DECISIONS に追記。
3. **UI 実装**
   - 新セクションコンポーネント（`DashboardCharts`, `DashboardDetailsTable`, `DashboardAlertTimeline`）。
   - カードのトレンド表示とリンク動作を実装。
4. **インタラクション**
   - フィルタ状態をURLクエリ or Zustandで保持。
   - KPI設定変更後、グラフ/テーブルが再計算されることを確認。
5. **エクスポート/通知**
   - 詳細テーブルに CSV/JSON エクスポートボタンを追加。
   - Slack通知はバックログとして docs に明記し、APIキー管理ポリシーを整理。

## テスト戦略
- **ユニットテスト**: `tests/dashboard.charts.test.tsx`（新設予定）でグラフデータ生成ロジックを検証。
- **レンダリングテスト**: `tests/dashboard.details.test.tsx` でテーブルの列設定とフィルタリング挙動をテスト。
- **スナップショット/ビジュアル**: Chrome DevTools CLI でダッシュボードのスクリーンショットを取得。
- **統合テスト**: KPI設定変更 → グラフ/テーブル反映を `tests/dashboard.interactions.test.tsx` で検証。

## リスクと対策
- **グラフライブラリの重量化**: 代替として `lightweight-charts` など軽量な選択肢を検証、ツリーシェイキング設定を確認。
- **データ不足**: 日別集計に必要な履歴が無い場合は、Diffベースラインからスナップショットを読み込むフォールバックを用意。
- **アクセスビリティ**: グラフの色覚対応（pattern fill、ARIA説明）を実装し、WCAGチェックリストに追加。
- **パフォーマンス**: 大量Dutyでの集計コスト増 → Web Worker or lazy計算を検討。

## ロードマップ（概算工数）
1. Week1: データ拡張 + 設計固め（1.5日）  
2. Week2: グラフセクション実装 + 基本テスト（2.5日）  
3. Week3: 詳細テーブル・アラートタイムライン + エクスポート（2日）  
4. Week4: テスト統合・Docs更新・ロールアウト準備（2日）

## 関連ドキュメント
- `docs/specs/file-write-audit.md`
- `docs/specs/distribution-approval.md`
- `docs/specs/diff-export-rollout.md`
- `docs/DECISIONS_2025-10-06.md`
- `docs/TODO.md`
