# 北極星ゴール（SSOT: Plans）

本プロダクトは、バス事業者の計画業務（行路＝Block・交番＝Duty）を支援するSaaSのMVPです。Step1では、既存のGTFSを読み込み、選んだ路線を地図とタイムラインで可視化し、便の連結（行路）と交番をドラッグ操作で手作りします。作業中は、休憩不足・連続運転超過・未割当などの警告と、回送比率などの効率指標を表示しますが、保存は決して妨げません。GTFSにない情報（車両・ドライバー・倉庫/交代所・労務ルール）はCSVで補完し、現場の判断で前に進めます。画面は「車両軸（Vehicle）」と「ドライバー軸（Driver）」を切り替えられ、どちらで編集しても即時に同期されます。Step2では、蓄積したデータを基に、最適化ソルバで自動配置へ拡張します（本MVPでは実行しません）。

---

## MVP範囲
- Step1（本MVP）: 手動最適化UI（可視化・警告・効率指標・CSV入出力・保存は常に可能）。自動決定はしない。
- Step2（参考/非スコープ）: 最適化ソルバ（CP-SAT/MIP等）で行路・交番の自動配置。要件は後続で定義。

## 主要シナリオ（Step1）
1. 既存GTFSを読み込み、対象路線を選択（地図でルート確認しながら取り込み）。
2. GTFSにない情報を補完: 車両（機材）・従業員・倉庫/交代所・労務ルールなどをCSVで追加。
3. Blocks（Vehicle軸）で便の端点をつなぎ、行路を作成（ドラッグ＆ドロップ、提案は表示・自動確定なし）。
4. Duties（Driver軸）でドライバーを割付（未割付は未割当グループで管理、ドラッグで当て込む）。
5. 警告を確認・解消しつつ、CSVに保存/出力（警告が残っていても保存可）。

## 画面構成
- Explorer: ルート一覧／個別（地図＋タイムライン）。
- Blocks（Vehicleビュー・縦=vehicle_id）: 行路編集の主画面、端点連結、警告、効率ダッシュ。
- Duties（Driverビュー・縦=driver_id）: 交番割付の主画面、休憩・勤務制限の確認。

## データ準備（入出力）
- 入力: GTFS（routes/trips/stop_times）＋ 追加CSV（vehicles, drivers, depots, relief_points, labor_rules 等）。
- 出力: `blocks.csv`（`block_id, sequence, trip_id, start_time, end_time, vehicle_id(optional)`）
        `duties.csv`（`duty_id, driver_id, block_id, start_time, end_time`）
- 参考: 内部表 `events`（営業/回送/出入庫/休憩/点検/待機...）はUI同期と警告生成のみに利用。

## 設定入力方針（重要）
- 入力手段は Web UI を主とし、CSV は初期インポート/大量更新/バックアップに限定して補助利用とする。
- 設定はDBを正（SSOT）とし、いつでもCSVにエクスポート/インポートできるスナップショット運用を許容。

## 設定UI（折り返し/交代所/Depot）
- 最小折返し時間（Hard）: 折返し地点ごとの下限（分）。違反は0件を目標。
- 目標レイオーバー（Soft）: 望ましい余裕（分）。不足は警告のみで保存可。
- 交代所（Relief）: 利用可否、時間ウィンドウ（開始〜終了）。
- Depot: 入出庫ウィンドウ、車両配置の既定。
- 時間帯/曜日/特例での上書きに対応（イベント日・繁忙期など）。

## 労務ルールUI（ドライバー）
- 連続運転上限（Hard）、休憩最小（Hard/Soft）、拘束/実働上限、深夜帯規定。
- 資格/免許/所属と路線・車両の適合（Hard）。
- 勤務パターン（早番/遅番等）、希望休/不可日、残業上限（Soft）。

## 階層上書きと可視化
- 優先順位: グローバル既定 → 拠点（Depot/エリア） → 路線/系統 → 折返し地点 → 便特例。
- 画面に「有効ルールの由来」を常時表示（どの層が適用されているかをバッジで明示）。

## 出力時確認（非ブロッキング）
- 保存は常に可能（Step1原則）。
- 公開/CSV出力時は、Hard/Soft件数・未割付・主要指標（回送比率/レイオーバー確保率/交番可用率）の要約を確認ダイアログで提示。ユーザーは続行可能（ブロックしない）。
- 設定変更はドラフト→レビュー→適用の二段階。適用前に影響プレビュー（Hard/Soft件数の変化）を表示。

## 監査・権限
- すべての設定変更に対して監査ログ（誰が/いつ/何を）。
- ロール（管理者/計画担当/閲覧者）。ドラフトの承認権限を分離。
- 変更差分の比較、ロールバック機能を提供。

## 警告と効率指標（Step1の原則＝保存は妨げない）
- Hard違反（赤）: 連続運転超過／休憩不足／拘束・深夜帯違反／資格・所属不整合。
- Soft警告（黄）: 長大ブロック／デポ越境過多／給油・点検・余白不足／交代所未活用。
- 固定指標（上部ダッシュ）: 回送比率[%]、レイオーバー確保率[%]、交番可用率[%]、Hard/Soft件数（式はツールチップ）。
- 定義（初期）:
  - 回送比率[%] = 回送（deadhead）時間 or 距離 ÷ 総時間 or 総距離 × 100
  - レイオーバー確保率[%] = 各折返しで確保したレイオーバー合計 ÷ 目標必要レイオーバー合計 × 100
  - 交番可用率[%] = Hard違反が0のDuty数 ÷ 全Duty数 × 100

## 受け入れ基準（DoD/Step1）
1. GTFS読込でルート個別（地図＋タイムライン）を表示できる。
2. 便の端点を接続してブロック作成すると、直後に該当警告が表示される。
3. ドライバーを手動で割付し、交番CSVを出力できる。
4. Hard/Soft警告が存在しても保存・出力できる（CSVに警告要約列を含める）。
5. Vehicle/Driverの二面ビューを切替でき、編集は相互に同期する。
6. 折返し/労務などの設定はWeb UIで編集でき、CSVは初期/一括/バックアップ用途で入出力できる。
7. 設定変更はドラフト→適用、監査ログとロールバックが有効。
8. 有効ルールの由来（階層）がUI上に可視化される。
9. 公開/CSV出力時に非ブロッキングの確認ダイアログが表示され、要約（Hard/Soft/未割付/指標）が示される。

## KPIと測定
- 交番可用率（= Hard違反0のDuty率）100%を目標（公開前には必ず0件）。
- 検証時間50%削減、違反検知70%短縮を目標。
- UI操作ログから「連結→警告確認→保存」までの所要を自動集計して評価。

## 非スコープ（Step1でやらない）
- 自動最適化（CP-SAT/MIP等）、交番自動割付、常時自動エクスポート。

## 実行TODO（MVP完了までの順序）
- [ ] 0. 準備とデータ健全性確認（docs/specs/requirements-blocks-duties.md）
  - 参照: readme.md: クイックスタート／GTFS読込
  - 実行: `npx tsx tools/gtfsHealthCli.ts <path-to-gtfs.zip>`（Blocklessや時刻延長を確認）
- [ ] 1. Explorer（取り込み/路線選択/地図＋タイムライン）（docs/specs/ui-mock.md, docs/specs/timeline-interactions.md）
  - 実行: `make preview` → `make generate-snapshots`
- [ ] 2. Blocksエディタ（端点連結＝手動／提案のみ）（docs/specs/block-ui-redesign.md, requirements-blocks-duties.md）
  - 実行: スナップショット基準合格 ≤ 0.5%、Chrome DevToolsチェック `npm run devtools:landing-hero`
- [ ] 3. Dutiesエディタ（ドラッグ割付／未割当グループ）（docs/specs/duty-editing.md, duty-editing.addendum.md）
- [ ] 4. 警告（Hard/Soft）即時表示と内訳（requirements-blocks-duties.md）
- [ ] 5. 効率指標ダッシュ（回送/レイオーバー/可用率）（docs/specs/kpi-ux-panel.md）
- [ ] 6. 二面ビュー切替と編集同期（Vehicle/Driver）（ui-mock.md, timeline-interactions.md）
- [ ] 7. CSV入出力（blocks.csv/duties.csv）＋警告要約列（docs/specs/diff-export-scope.md, diff-export-rollout.md, file-write-audit.md）
- [ ] 8. 設定UI（Web主・CSV補助）折返し/交代所/Depot/労務（テンプレ→自社上書き）（docs/templates/*.template.csv）
  - 参照: depots/relief_points/drivers/deadhead_rules テンプレ群
  - TODO: 設定UI仕様ドキュメントを追加（例: `docs/specs/settings-ui.md`）
- [ ] 9. 出力時確認ダイアログ（非ブロッキング）（docs/specs/kpi-ux-panel.md 付録に統合）
- [ ] 10. 監査ログ（操作/設定変更）とプライバシー（docs/specs/file-write-audit.md, readme.md: プライバシー）
- [ ] 11. KPI計測（UIログ）とレポート（kpi-ux-panel.md）
- [ ] 12. ドキュメント整備と最終チェック（README/Plans/テンプレ最新化）

### 参照ドキュメント索引
- Explorer/タイムライン: `docs/specs/ui-mock.md`, `docs/specs/timeline-interactions.md`
- Blocks: `docs/specs/block-ui-redesign.md`, `docs/specs/requirements-blocks-duties.md`
- Duties: `docs/specs/duty-editing.md`, `docs/specs/duty-editing.addendum.md`
- 指標/KPI/UX: `docs/specs/kpi-ux-panel.md`
- 出力時確認: `docs/specs/output-confirmation.md`
- 出力/差分: `docs/specs/diff-export-scope.md`, `docs/specs/diff-export-rollout.md`
- 監査: `docs/specs/file-write-audit.md`
- CSVテンプレ: `docs/templates/*.template.csv`
- 設定UI: `docs/specs/settings-ui.md`

### 実行コマンド索引（検証）
- ビルド/プレビュー: `make preview`
- UIスナップショット: `make generate-snapshots`（閾値0.5%）
- DevToolsヒーロー確認: `npm run devtools:landing-hero`
- GTFSヘルスチェック: `npx tsx tools/gtfsHealthCli.ts <zip>`

---

## TODO別 要件定義（MVP）

0) 準備とデータ健全性確認（GTFS）
- ゴール: 取り込み可能なGTFSと既知の問題（blockless/時間延長等）を把握。
- 入力: `<gtfs>.zip`（routes, trips, stops, stop_times）。
- 操作: CLIでヘルスチェックを実行し、結果を`logs/`へ保存。
- 出力: エラー/警告一覧、サマリーJSON。
- DoD: 重大エラー0、警告はPlansに記録、次工程に反映。

1) Explorer（取り込み/路線選択/地図＋タイムライン）
- ゴール: 対象路線を選び、地図/時間軸で把握できる。
- 入力: GTFS + 背景地図（MapLibre）。
- 操作: 検索/フィルタ/選択、ルート個別の時系列表示。
- 出力: 選択状態の保持、スクリーンショット。
- DoD: ルート個別が正しい順序で描画、1秒以内にパン/ズーム応答。

2) Blocksエディタ（端点連結＝手動／提案のみ）
- ゴール: 便の端点を手で連結しBlockを作成、提案は表示のみ。
- 入力: trips, stop_times、接続閾値（距離/時間）。
- 操作: ドラッグ/クリックで接続、複数候補はリスト提示（自動確定なし）。
- 出力: `blocks.csv`プレビュー、未連結警告の即時表示。
- DoD: 連結/解除/並び替えができ、差分が即時に表示。

3) Dutiesエディタ（ドラッグ割付／未割当グループ）
- ゴール: ドライバーを手で割付、未割当を一元管理。
- 入力: `drivers.csv`、Block一覧。
- 操作: 未割当→Driverへドラッグ、解除で未割当へ戻る。
- 出力: `duties.csv`プレビュー。
- DoD: 割付/解除/移動ができ、Undo/Redo 10段保持。

4) 警告（Hard/Soft）即時表示と内訳
- ゴール: ルールに基づくHard/Softを秒以内に反映。
- 入力: 折返し/労務ルール（設定UIが正）。
- 操作: タイムライン上にバッジ表示、一覧で根拠を参照。
- 出力: CSV出力に警告要約列を含める。
- DoD: Hard/Softの件数一致、内訳に根拠リンク。

5) 効率指標ダッシュ（回送/レイオーバー/可用率）
- ゴール: 指標を固定表示し、編集に応じて再計算。
- 入力: Blocks/Duties/設定。
- 操作: ダッシュのツールチップに計算式表示。
- 出力: スクリーンショット、数値ログ。
- DoD: 指標の一致（テストデータで期待値±1%）。

6) 二面ビュー切替と編集同期（Vehicle/Driver）
- ゴール: 2ビューで同一データを編集、即時同期。
- 操作: ビュータブ切替、編集中の反映を確認。
- DoD: どちらで編集してももう一方に200ms以内で反映。

7) CSV入出力（blocks/duties）＋警告要約列
- ゴール: CSVの入出力ができ、警告要約列を含める。
- 入力: `blocks.csv`, `duties.csv`。
- 操作: Export/Import、差分プレビュー。
- 出力: ファイル、監査ログ。
- DoD: 冪等（Export→Import→Exportで一致）。

8) 設定UI（Web主・CSV補助）折返し/交代所/Depot/労務
- ゴール: 設定系はUIで編集、CSVは大量更新の補助。
- 入力: 既定テンプレ＋自社上書き。
- 操作: フォーム編集、由来バッジ、階層上書き。
- 出力: 設定スナップショット、監査ログ。
- DoD: 新旧設定の差分表示、ロールバック可。

9) 出力時確認ダイアログ（非ブロッキング）
- ゴール: 出力直前に要約を提示し続行可。
- 入力: Hard/Soft件数、未割付、指標。
- 操作: ダイアログ表示、CSV続行ボタン。
- 出力: 操作ログ（確認ありで出力）。
- DoD: 値がUIと一致、50ms以内に描画。

10) 監査ログ（操作/設定変更）とプライバシー
- ゴール: 重要操作に監査記録、個人特定情報は含めない。
- 入力: 操作イベント、設定変更差分。
- 出力: 監査ファイル/DB（期間保存）。
- DoD: 主要イベント100%記録、PIIなしを検査。

11) KPI計測（UIログ）とレポート
- ゴール: 連結→警告確認→保存の所要を自動集計。
- 入力: UI操作ログ。
- 出力: KPIダッシュの週次集計。
- DoD: 指標が週次で自動更新、CSVエクスポート可。

12) ドキュメント整備と最終チェック
- ゴール: README/Plans/テンプレが最新で一貫。
- DoD: 参照リンクの死活0、手順で再現可。

## 決定ログ
- 2025-10-20: Step1では一切の自動確定を行わない。候補提示と警告表示に限定。
- 2025-10-20: 二面ビュー（Vehicle/Driver）は編集即時同期とする。
- 2025-10-20: 設定入力はWeb UIを主、CSVは初期/一括/バックアップの補助とする。
- 2025-10-20: MVPはゲートを設けず、出力時は非ブロッキングの確認ダイアログのみ。

## 未決事項
- 効率指標の最終セット（増減）と各式の定義（初期定義はREADME参照）。
- 時刻表現の固定（GTFS準拠 HH:MM:SS/24h拡張）で運用開始、必要ならタイムゾーン設定を追加。

## To-Do（Step1/ドキュメントのみ）
- [ ] 指標ツールチップの数式をREADMEに追記
- [ ] 追加CSVスキーマ（labor_rules等）の最小例を `docs/templates/` に用意
- [ ] Explorer/Blocks/Duties のスクリーン図（ラフ）を `docs/specs/ui-mock.md` に反映

---

## 付録: 既存 Exec Plan（MCPツールの運用）

（ここから下は既存のMCPツール計画の要旨を保持し、履歴として残します）

### 全体像
AGENTSガイドに基づき、Context7 と Chrome DevTools を用いた MCP ツール運用を整備する。`tsx` ベースで再現性のある実行環境を維持し、必要スクリプトとドキュメントを更新してエージェントからのアクセス性を向上させる。

### 進捗状況
- [x] スパイク: MCPツールの導入・実行手順の確認
- [x] 実行手段: CLIスクリプトを `tsx` に統一
- [x] テスト追加: 主要コマンド（usage）の実行確認
- [x] ドキュメント更新: AGENTS.md に運用を記載
- [x] フォールバック: Context7 MCP 実行失敗時の代替手順を明記

### 発見と驚き
- Context7系 CLI の `ts-node` 依存を廃し `tsx` に統一して安定化。
- `context7-mcp` は `npx -y @upstash/context7-mcp` で迅速起動が可能。
- MCPドキュメント取得はネットワーク依存のためHTTPフォールバックを用意。

### 決定ログ（MCP）
- 2025-10-20: 実行系は `tsx` に統一し、開発サーバ連携を明文化。
- 2025-10-20: MCP 実行は `tools/context7Cli.ts` を軸に、必要時はHTTPフォールバックで対応。

### To-Do（MCP）
1. [x] MCPツールの一覧と起動手順の確認
2. [x] Context7 CLI の実行コマンドを `tsx` ベースに統一
3. [x] AGENTS.md へ運用の追記
4. [x] `package.json` に補助スクリプトを追加
5. [x] Context7 MCP フォールバック手順（`npm run context7:docs -- <libraryId>` 等）を明記
